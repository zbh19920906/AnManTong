//
//  KKPersonalController.m
//  CloudMoto
//
//  Created by KKJY on 2017/10/26.
//  Copyright © 2017年 zhu. All rights reserved.
//

#import "KKPersonalController.h"
#import "KKPersonalCell.h"
#import "MyUIHelper.h"
#import "MyUIHelperModel.h"
#import "KKPersonalViewModel.h"
#import "CPBottomPromitView.h"
NSString *const PersonalCell = @"PersonalCell";
@interface KKPersonalController ()<
UITableViewDelegate,
UITableViewDataSource,
CPBottomPromitViewDelegate,
UINavigationControllerDelegate,
UIImagePickerControllerDelegate>
@property (nonatomic, strong) UIButton *backButton;
@property (nonatomic, retain) BaseTableView *tableView;
@property (nonatomic, strong) NSMutableArray *dataArr;
@end

@implementation KKPersonalController

-(void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    [self.tableView reloadData];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    self.navBar.titieLab.text =  @"个人信息";
    self.dataArr = [MyUIHelper personalDataArr];
    [self.view addSubview:self.tableView];
    self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc]initWithCustomView:self.backButton];
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return  self.dataArr.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    KKPersonalCell *cell = [tableView dequeueReusableCellWithIdentifier:PersonalCell forIndexPath:indexPath];
    MyUIHelperModel *model = self.dataArr[indexPath.row];
    cell.imageView.hidden = indexPath.row == 0 ? NO : YES;
    cell.detailTextLabel.hidden = indexPath.row == 0 ? YES : NO;
    cell.model = model;
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.row == 0) {
        CPBottomPromitView *bottomView = [CPBottomPromitView bottomPromitView];
        [bottomView cpSetTitles:@[@"拍照",@"我的相册"] details:nil titleColors:@[[UIColor cz_ToUIColorByStr:@"333333"],[UIColor cz_ToUIColorByStr:@"333333"]] detailsColors:nil];
        bottomView.cpDelegate = self;
        [bottomView show];
    }
    [KKPersonalViewModel pushPersonalViewController:self indexPath:indexPath];
    
    [self.tableView deselectRowAtIndexPath:indexPath animated:YES];
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return indexPath.row == 0 ? 80 : 44;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    return 10;
}

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section
{
    return .1;
}

- (void)backViewController
{
    [self.navigationController popViewControllerAnimated:YES];
}

- (void)cpBottomPromitView:(CPBottomPromitView *)bottomPromitView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.row == 0) {
        [self getImageFromCamera];
    }else if (indexPath.row == 1){
        [self getImageFromIpc];
    }
}

- (void)getImageFromCamera
{
    if (![UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) return;
    if ([NSObject isVideo] == YES) {
        UIImagePickerController *ipc = [[UIImagePickerController alloc] init];
        ipc.sourceType = UIImagePickerControllerSourceTypeCamera;
        ipc.delegate = self;
        ipc.allowsEditing = YES;
        [self presentViewController:ipc animated:YES completion:nil];
    }else{
        ZLAlertView *alertView = [[ZLAlertView alloc] initWithTitle:@"提示" message:@"请在设置->隐私->相机中打开"];
        [alertView addBtnTitle:@"取消" action:^{
        }];
        [alertView addBtnTitle:@"前去开启" action:^{
            [NSObject versionsJudge:@"去开启"];
        }];
        [alertView showAlertWithSender:getWindow.rootViewController];
    }
}

- (void)getImageFromIpc
{
    if (![UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypePhotoLibrary]) return;
    UIImagePickerController *ipc = [[UIImagePickerController alloc] init];
    ipc.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;
    ipc.delegate = self;
    ipc.allowsEditing = YES;
    ipc.navigationBar.tintColor = [UIColor cz_ToUIColorByStr:@"333333"];
    [self presentViewController:ipc animated:YES completion:nil];
}

#pragma mark - UIImagePickerControllerDelegate
// 获取图片后的操作
- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary<NSString *,id> *)info
{
    [picker dismissViewControllerAnimated:YES completion:nil];
    
    weakSelf(self);
    [self.view kk_showHUDWithTitle:@"上传中"];
    [KKNetworkManager upLoadHeadImageWithHeadImage:info[UIImagePickerControllerEditedImage] block:^(BOOL isSuccess, id json){
        if (isSuccess) {
            [UserHelper shareInstance].user.head_img = json[@"data"];
            [UserHelper saveModifiedPersonalDetailInfoToCache];
            if (weakSelf.imageBlock) {
                weakSelf.imageBlock(info[UIImagePickerControllerEditedImage]);
            }
            [weakSelf.tableView reloadData];
            [weakSelf.view kk_showCenterHUDWithTitle:@"上传成功"];
            [weakSelf afterProgressHidden];
        }else{
            [weakSelf.view kk_showCenterHUDWithTitle:@"上传失败"];
            [weakSelf afterProgressHidden];
        }
    }];
}

- (void)afterProgressHidden
{
    weakSelf(self);
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        [weakSelf.view kk_hideHUD];
    });
}

- (NSMutableArray *)dataArr
{
    if (!_dataArr) {
        _dataArr = [[NSMutableArray alloc]init];
    }
    return _dataArr;
}

- (BaseTableView *)tableView
{
    if (!_tableView) {
        _tableView = [[BaseTableView alloc]initWithFrame:CGRectMake(0, NavHFit, WIDTH_SCREEN, HEIGHT_SCREEN) style:UITableViewStyleGrouped];
        _tableView.delegate = self;
        _tableView.dataSource = self;
        _tableView.scrollEnabled = NO;
        _tableView.separatorColor = [UIColor cz_ToUIColorByStr:@"ebebeb"];
        _tableView.backgroundColor = [UIColor cz_ToUIColorByStr:@"f5f5f5"];
        [_tableView registerClass:[KKPersonalCell class] forCellReuseIdentifier:PersonalCell];
    }
    return _tableView;
}

- (UIButton *)backButton
{
    if (!_backButton) {
        _backButton = [UIButton buttonWithType:UIButtonTypeCustom];
        [_backButton setImage:imageNamed(@"fanhui") forState:UIControlStateNormal];
        _backButton.frame = CGRectMake(0, 0, 30, 30);
        _backButton.imageEdgeInsets = UIEdgeInsetsMake(0, WIDTHFit(-20), 0, 0);
        [_backButton addTarget:self action:@selector(backViewController) forControlEvents:UIControlEventTouchUpInside];
    }
    return _backButton;
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}


@end
