//
//  KKNameAndAgeController.m
//  CloudMoto
//
//  Created by KKJY on 2017/10/27.
//  Copyright © 2017年 zhu. All rights reserved.
//

#import "KKNameAndAgeController.h"
#import "KKTextField.h"
@interface KKNameAndAgeController ()<UITextFieldDelegate>
@property (nonatomic, retain) UIButton *saveButton;
@property (nonatomic, retain) UILabel *promptLabel;
@property (nonatomic, retain) KKTextField *textField;

@end

@implementation KKNameAndAgeController

- (void)viewDidLoad
{
    [super viewDidLoad];
    self.navBar.rightButton.enabled = YES;
    self.view.backgroundColor = [UIColor groupTableViewBackgroundColor];
    self.navBar.titieLab.text = self.isHidden == YES ? @"年龄":@"修改昵称";
    [self.navBar.rightButton setTitle:@"保存" forState:UIControlStateNormal];
    [self.navBar.rightButton setLableColor:@"909090" font:15 bold:0];
    
    [self.view sd_addSubviews:@[self.textField,self.promptLabel]];
    self.promptLabel.hidden = self.isHidden;
    self.promptLabel.sd_layout
    .topSpaceToView(self.textField, 20)
    .centerXEqualToView(self.view)
    .heightIs(14);
    [self.promptLabel setSingleLineAutoResizeWithMaxWidth:200];
    if ([self.navBar.titieLab.text isEqualToString:@"年龄"]) {
        self.textField.keyboardType = UIKeyboardTypeNumberPad;
    }else{
        self.textField.keyboardType = UIKeyboardTypeDefault;
    }
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    [self.textField resignFirstResponder];
}

- (BOOL)checkBankCardInfo
{
    BOOL flag = YES;
    NSString *msg = @"";
    if ([self.navBar.titieLab.text isEqualToString:@"修改昵称"]) {
        if (self.textField.text.length > 16) {
            msg = @"请输入的昵称不能大于16";
            flag = NO;
        }
    }else{
        
    }
    if (!flag) {
        [self.view kk_showCenterHUDWithTitle:msg];
    }
    return flag;
}

- (void)clickRightButtonAction:(id)sender
{
    [self.textField resignFirstResponder];
    
    weakSelf(self);
    self.textField.text = [self.textField.text stringByReplacingOccurrencesOfString:@" " withString:@""];
    if ([self.textField.text isEqualToString:@""]||[self.textField.text isEqualToString:@" "]) {
        ZLAlertView *alertView = [[ZLAlertView alloc] initWithTitle:@"提示" message:@"输入的名字不能为空"];
        [alertView addBtnTitle:@"确定" action:^{}];
        [alertView showAlertWithSender:getWindow.rootViewController];
    }else{
        
        if (![self checkBankCardInfo]) {
            return;
        }
        self.navBar.rightButton.enabled = NO;
        [self.view kk_showHUDWithTitle:@"修改中"];
        User *userObjc = [UserHelper shareInstance].user;
        NSDictionary *dic = self.isHidden == YES ?@{@"age":self.textField.text,@"sex":userObjc.sex,@"default_payment":userObjc.default_payment} : @{@"nickname":self.textField.text,@"sex":userObjc.sex,@"default_payment":userObjc.default_payment};
        [KKNetworkManager upDataUserInfoForUserMessage:dic block:^(BOOL isSuccess, id json) {
            if (isSuccess) {
                if (weakSelf.isHidden) {
                    userObjc.age = weakSelf.textField.text;
                }else{
                    userObjc.nickname = weakSelf.textField.text;
                }
                [UserHelper saveModifiedPersonalDetailInfoToCache];
                [weakSelf.view kk_showHUDWithTitle:@"修改成功"];
                [weakSelf afterProgressHidden];
            }else{
                [weakSelf.view kk_showHUDWithTitle:@"修改失败"];
                [weakSelf afterProgressHidden];
            }
        }];
    }
    
}

- (BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string
{
    if (textField == self.textField) {
//        //这里的if时候为了获取删除操作,如果没有次if会造成当达到字数限制后删除键也不能使用的后果.
//        if (range.length == 1 && string.length == 0) {
//            return YES;
//        }
//        //so easy
//        else if (self.textField.text.length >= 16) {
//            self.textField.text = [textField.text substringToIndex:16];
//            return NO;
//        }
        if ([self.navBar.titieLab.text isEqualToString:@"年龄"]) {
            if (self.textField.text.length== 2) {
                if ([string isEqualToString:@""]) {                          
                    return YES;
                }else{
                    self.textField.text = [textField.text substringToIndex:2];
                    return NO;
                }
            }else{
                return YES;
            }
           
        }
    }
    return YES;
}

- (void)afterProgressHidden
{
    weakSelf(self);
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        [weakSelf.view kk_hideHUD];
        [weakSelf.navigationController popViewControllerAnimated:YES];
    });
}

- (void)backViewController
{
    [self.navigationController popViewControllerAnimated:YES];
}

- (UILabel *)promptLabel
{
    if (!_promptLabel) {
        _promptLabel = [[UILabel alloc]init];
        [_promptLabel setLableColor:@"909090" font:12 bold:0];
        _promptLabel.text = @"限1-16个字符,一个汉字为一个字符";
    }
    return _promptLabel;
}

- (KKTextField *)textField
{
    if (!_textField) {
        _textField = [[KKTextField alloc]initWithFrame:CGRectMake(0, 20 + NavHFit, WIDTH_SCREEN, 50)];
        _textField.textColor = [UIColor cz_ToUIColorByStr:@"323232"];
        _textField.textAlignment = NSTextAlignmentLeft;
//        _textField.borderStyle = UITextBorderStyleRoundedRect;
        _textField.layer.cornerRadius = 4;
        _textField.delegate = self;
        _textField.layer.masksToBounds = YES;
        _textField.backgroundColor = [UIColor whiteColor];
        _textField.text = [self.navBar.titieLab.text isEqualToString:@"年龄"] ? [UserHelper shareInstance].user.age : [UserHelper shareInstance].user.nickname;
    }
    return _textField;
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
